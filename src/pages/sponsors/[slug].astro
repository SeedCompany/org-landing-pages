---
import * as editorJs from '~/editorjs';
import { graphql, graphqlClient } from '~/graphql';
import { portableText } from '~/sanity';
import Layout from '~/layouts/Layout.astro';
import '../../styles/global.css';

const SponsorDetailDoc = graphql(`
  query SponsorDetail($id: ID!) {
    globalTranslationLeader(id: $id) {
      id
      shortCode
      name
      region
      gender
      focus
      biography
      image
      funding {
        remaining(applyPledges: true)
      }
    }
  }
`);

const { slug } = Astro.params as { slug: string };
const { data } = await graphqlClient.query(SponsorDetailDoc, { id: slug }).toPromise();
const sponsor = data?.globalTranslationLeader;
if (!sponsor) {
  return Astro.redirect('/404');
}
const isSponsored = sponsor.funding.remaining === 0;
---

<Layout>
  <div class="bg-[var(--sus-primary-heading)] min-h-screen text-white py-12">
    <div class="container border-white border-2 rounded-lg mx-auto p-8 md:py-12">
      <div class="mb-8">
        <a href="/global-translation-leaders" class="text-[var(--sus-button-secondary-bg)] hover:underline">
          ‚Üê Back to Global Translation Leaders
        </a>
      </div>

      <div class="block md:flex gap-12">
        <div class="w-full md:w-1/2">
          {sponsor.image && (
            <img
              src={sponsor.image}
              alt={`Photo of ${sponsor.name}`}
              class=`rounded-lg w-full mb-6 ${isSponsored ? 'grayscale opacity-40' : ''}`
            />
          )}
        </div>

        <div class="w-full">
          <div>
            <div class="w-full">
                <h1 class="text-4xl lg:text-6xl font-bold mb-4">{sponsor.name}</h1>
            </div>
            <div class="space-y-2 mb-8 md:grid grid-cols-2">
                <p class="mt-2"><strong>Region:</strong> {sponsor.region}</p>
                <p><strong>Gender:</strong> {sponsor.gender}</p>
                <p><strong>GTL ID:</strong> {sponsor.shortCode}</p>
                <p><strong>Focus:</strong> {sponsor.focus}</p>
            </div>
          </div>
        </div>
        <div class="w-full">
          <div>
            <div class="space-y-4 mb-6">
                {!isSponsored && (
                <form action="">
                    <input type="text" placeholder="Your message..." class="border border-gray-300 p-2 rounded-lg w-full" />
                </form>
                )}
                {isSponsored && (
                    <div class="bg-[var(--sus-button-secondary-bg)] text-black p-4 rounded-lg">
                    <p class="font-semibold">This leader is currently sponsored!</p>
                    </div>
                )}
            </div>
          </div>
        </div>
      </div>

      <div class="mb-8">
        <h2 class="text-2xl font-bold mb-4">Biography</h2>
        <p class="text-lg leading-relaxed"
           set:html={portableText.toHTML(editorJs.toPortableText(sponsor.biography))} />
      </div>
    </div>

  </div>
</Layout>
