---
import { Image } from 'astro:assets';
import { css, cx } from 'styled-system/css';
import { styled, Center, Divider, HStack, Stack } from 'styled-system/jsx';
import { stack } from 'styled-system/patterns';
import { token } from 'styled-system/tokens';
import type { JsxStyleProps } from 'styled-system/types';
import { ButtonLink } from '~/common/ui';
import * as editorJs from '~/editorjs';
import { type FragmentType, graphql, useFragment } from '~/graphql';
import { portableText } from '~/sanity';

const SponsorCardFragment = graphql(`
  fragment sponsorCard on GlobalTranslationLeader {
    id
    shortCode
    name
    region
    gender
    focus
    biography
    image
    funding {
      remaining(applyPledges: true)
    }
  }
`);

interface Props extends JsxStyleProps {
  sponsor: FragmentType<typeof SponsorCardFragment>;
}

const sponsor = useFragment(SponsorCardFragment, Astro.props.sponsor);
const { name, region, gender, shortCode: gtlId, focus, image: imageUrl, id: slug } = sponsor;
const isSponsored = sponsor.funding.remaining === 0;
---

<article
  data-disabled={isSponsored ? true : undefined}
  class={cx('group', stack({ color: 'white' }), css(Astro.props.css))}
>
  <Stack
    css={{
      height: 'full',
      borderWidth: 'thin',
      rounded: 'l4',
      '--gap': { base: token('spacing.4') },
      p: 'var(--gap)',
      gap: 'var(--gap)',

      filter: 'auto',
      _groupDisabled: {
        grayscale: '100%',
        opacity: 0.4,
      },
    }}
  >
    <HStack css={{ gap: '[inherit]' }}>
      <Image src={imageUrl} alt="" inferSize={true} class={css({ rounded: 'l3', width: '1/3' })} />
      <Stack css={{ flex: '1', gap: '[inherit]' }}>
        <styled.h3 css={{ fontSize: '2xl' }}>
          {name}
        </styled.h3>
        <Stack
          css={{
            fontSize: { smDown: 'sm' },
            gap: '[calc(var(--gap) / 2)]',
            containerType: 'inline-size',
          }}
        >
          <p>
            <strong>Region:</strong>
            {region}
          </p>
          <Divider css={{ opacity: 0.5 }} />
          <Stack
            css={{
              gap: '[inherit]',
              flexDir: 'column',
              '@container (min-width: 225px)': { flexDir: 'row' },
            }}
          >
            <p>
              <strong>Gender:</strong>
              {gender}
            </p>
            <Divider
              orientation="vertical"
              css={{
                opacity: 0.5,
                height: '[unset]',
                alignSelf: 'stretch',
                '@container (max-width: 225px)': { display: 'none' },
              }}
            />
            <p>
              {gtlId}
            </p>
          </Stack>
        </Stack>
      </Stack>
    </HStack>
    <HStack justify="space-between" gap="[inherit]" css={{ flexWrap: 'wrap' }}>
      <ButtonLink
        href={`/global-translation-leaders/${slug}`}
        variant={isSponsored ? 'outline' : 'solid'}
        css={{ rounded: 'l3' }}
      >
        View Details
      </ButtonLink>
      <styled.p css={{ _groupDisabled: { display: 'none' } }}>$1,000 month needed</styled.p>
    </HStack>
    <styled.p css={{ fontSize: 'lg', fontWeight: 'bold' }}>
      Focus: {focus}
    </styled.p>
    <styled.div css={{ lineClamp: 4 }}>
      <styled.p set:html={portableText.toHTML(editorJs.toPortableText(sponsor.biography))} />
    </styled.div>
  </Stack>
  {
    isSponsored && (
      <Center css={{ position: 'absolute', inset: '0', pointerEvents: 'none' }}>
        <styled.span
          css={{
            textStyle: 'title1',
            fontSize: '3xl',
            bg: 'secondary.a10',
            rounded: 'l4',
            lineHeight: 'none',
            p: '8',
          }}
        >
          Sponsored
        </styled.span>
      </Center>
    )
  }
</article>
