---
import { sanityClient as sanity, portableText } from '~/sanity';
import BaseLayout from '~/layouts/BaseLayout.astro';

// Import the templates for different campaign types
import AdvocatesTemplate from '../../components/templates/AdvocatesTemplate.astro';
import InvestorRepsTemplate from '../../components/templates/InvestorRepsTemplate.astro';
import MarketingTemplate from '../../components/templates/MarketingTemplate.astro';
import SustainersTemplate from '../../components/templates/SustainersTemplate.astro';
import ChurchTemplate from './watermark/_components/ChurchTemplate.astro';
import { campaignBySlug } from './campaignBySlug.groq';

// Map templates from Sanity to Astro components
const templateMap = {
  advocates: AdvocatesTemplate,
  investorReps: InvestorRepsTemplate,
  marketing: MarketingTemplate,
  sustainers: SustainersTemplate,
  church: ChurchTemplate,
};

const { slug } = Astro.params as { slug: string };

const campaign = await sanity.fetch(campaignBySlug, { slug });
if (!campaign) {
  return new Response(null, {
    status: 404,
    statusText: 'Not Found',
  });
}

// Determine which template to use
const TemplateComponent = templateMap[campaign.templateType!] || MarketingTemplate;
const pageTitle =
  campaign.pageTitle ||
  (campaign.heading ? portableText.toPlain(campaign.heading) : 'Campaign Page');
---

<BaseLayout title={pageTitle}>
  <main>
    {/* Render the template with campaign data */}
    {campaign && TemplateComponent && <TemplateComponent campaignData={campaign} />}

    {/* Display warning if template type is unknown */}
    {
      campaign && !templateMap[campaign.templateType!] && (
        <div class="text-center py-10 text-orange-600">
          <p>Warning: Unknown template type '{campaign.templateType}'. Using default template.</p>
        </div>
      )
    }
  </main>
</BaseLayout>
