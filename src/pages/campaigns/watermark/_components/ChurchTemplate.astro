---
import { portableText } from '~/sanity';
import { FaqAccordion } from '~/common/FaqAccordion.tsx';
import MainLayout from '~/layouts/main/MainLayout.astro';
import Footer from '~/layouts/main/Footer.astro';
import Video from '../../../../components/Video.astro';
import type { Campaign } from '../../campaignBySlug.groq';
import Hero from './Hero.astro';
import ContentSection from './ContentSection.astro';
import DonationCard from './DonationCard.astro';
import GiveFormWithTotals from './GiveFormWithTotals.astro';

interface Props {
  campaignData: Campaign;
}

const { campaignData } = Astro.props;
const today = new Date();
const month = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
const day = String(today.getDate()).padStart(2, '0');
const todayFormatted = `${month}/${day}`;
const sept19 = '09/19';
const isAfterSept19 = todayFormatted >= sept19;
---

<style>
  html {
    scroll-behavior: smooth;
  }
  .page {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 2rem;
    max-width: 1440px;
    margin: 0 auto;
  }
  /* Left content column */
  .content {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }
  .donation-faq {
    max-width: 1440px;
    margin: 0 auto;
  }
  .faq-bg {
    height: 100%;
    background: linear-gradient(to top, #ebebec 0%, #ebebec 50%, #ffffff 100%);
  }
  /* Right form column (Sticky) */
  @media (min-width: 1024px) {
    .form-desktop {
      position: sticky;
      top: 0%;
      transform: translateY(-20%);
      align-self: start;
    }
    .content {
      padding: 60px;
    }
    /* Hide the inline mobile version */
    .content .form {
      display: none;
    }
    .faq-wrapper {
      max-width: 60%;
    }
    .faq-heading {
      margin-top: 2rem;
    }
    .bg-gradient {
      background: linear-gradient(to bottom, #ebebec 0%, #ebebec 50%, #ffffff 100%);
      position: absolute;
      top: 800px;
      left: 0;
      width: 100%;
      min-height: 800px;
      z-index: -1;
    }
    .hero-bg {
      background-image: url('https://cdn.sanity.io/media-libraries/ml0ZDygBMJD9/images/4fa5c4296731328c6124ba85e83e268705dcc8cf-1440x733.png');
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      min-height: 800px;
      z-index: -1;
    }
    .hero-bg-overlay {
      background: linear-gradient(to bottom, rgba(255, 255, 255, 0) 0%, #ebebeb 100%);
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      min-height: 800px;
      z-index: -1;
    }
    .mobile-donation-cta {
      display: none; /* hide mobile CTA on desktop */
    }
  }
  /* mobile */
  @media (max-width: 1023px) {
    .page {
      display: block;
      gap: 0;
    }
    .content {
      gap: 0;
      padding: 60px 30px;
    }
    .form-desktop {
      display: none; /* hide sticky desktop version */
    }
    .form-card {
      max-width: 750px;
    }
    .content .form {
      display: block;
      margin: 1.5rem 0;
      position: static;
      transform: none;
      width: 100%;
    }
    .hero-bg {
      background-image: url('https://cdn.sanity.io/media-libraries/ml0ZDygBMJD9/images/4fa5c4296731328c6124ba85e83e268705dcc8cf-1440x733.png');
      background-size: cover;
      background-repeat: no-repeat;
      background-position: right;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      min-height: 800px;
      z-index: -1;
    }
    .hero-bg-overlay {
      background: linear-gradient(
        to bottom,
        rgba(255, 255, 255, 0) 100%,
        rgba(255, 255, 255, 1) 0%
      );
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      min-height: 800px;
      z-index: -1;
    }
    .mobile-donation-cta {
      position: sticky;
      bottom: 1rem;
      left: 0;
      width: 90%;
      margin: auto;
      background: white;
      padding: 0.5rem;
      border-radius: 6px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
    .mobile-donation-cta a {
      width: 100%;
      padding: 1.5rem 2rem;
      font-size: 1.1rem;
      text-align: center;
      text-transform: uppercase;
      color: #000;
      font-family: 'Gotham Bold', sans-serif;
      font-weight: bold;
    }
    .footer-wrapper {
      margin-bottom: -140px !important;
    }
  }
  @media (max-width: 640px) {
    .faq-heading {
      font-size: 2rem;
      margin-top: 2rem;
    }
    .faq-question {
      font-size: 1rem;
    }
  }
</style>
<MainLayout
  title={campaignData.pageTitle ||
    (campaignData.heading ? portableText.toHTML(campaignData.heading) : 'Campaign Page')}
>
  <div class="page">
    <main class="content">
      <div class="hero-bg"></div>
      <div class="hero-bg-overlay"></div>
      <Hero />
      <aside class="form" id="give-form-mobile">
        <GiveFormWithTotals disableDialog={true} />
      </aside>
      <Video
        src="https://cdn.sanity.io/media-libraries/ml0ZDygBMJD9/files/8bface030986ea7054431c64dc16b6288678da12.mp4"
        poster="https://cdn.sanity.io/images/fgpinugl/production/f4acb3125ecdf71cda89fed9226821f08c7bcc22-1920x1080.jpg"
        class="hero-video"
        rounded={true}
      />
      <div class="bg-gradient"></div>
      {
        campaignData.aboutSections?.map((section) => (
          <ContentSection
            content={portableText.toHTML(section.content)}
            htmlContent={true}
            className="content-body"
          />
        ))
      }
      <h2
        class="text-4xl text-center md:text-left gotham-bold tracking-tight sm:text-5xl pt-12 pb-8 lg:py-4"
      >
        Unlock a Project.<br />Join the Mission.
      </h2>
      <DonationCard />
      <div class="prose">
        <div set:html={portableText.toHTML(campaignData.body)} />
      </div>
    </main>
    <aside class="form form-desktop">
      <GiveFormWithTotals />
    </aside>
  </div>

  <section class="faq-bg w-full">
    {
      campaignData.faqs && (
        <section class="donation-faq pb-16 z-100">
          {campaignData.templateType === 'church' &&
            campaignData.faqs[0]?.template === 'faqAccordion' && (
              <div class="faq-wrapper px-6 py-2 lg:pl-14 lg:pr-0">
                <h2 class="faq-heading text-4xl font-semibold tracking-tight text-gray-900 sm:text-5xl">
                  Frequently Asked Questions
                </h2>
                <FaqAccordion faqs={campaignData.faqs} client:load css={{ mt: '16' }} />
              </div>
            )}
          {campaignData.templateType === 'church' &&
            campaignData.faqs[0]?.template === 'faqGrid' && (
              <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <h2 class="text-3xl font-semibold tracking-tight text-gray-900 sm:text-4xl col-span-full">
                  Frequently Asked Questions
                </h2>
                {campaignData.faqs.map((faq) => (
                  <div>
                    <h3 class="text-lg font-semibold">{faq.question}</h3>
                    <div class="prose mt-2" set:html={portableText.toHTML(faq.answer)} />
                  </div>
                ))}
              </div>
            )}
          {campaignData.templateType === 'church' &&
            campaignData.faqs[0]?.template === 'faqList' && (
              <div>
                <h2 class="text-3xl font-semibold tracking-tight text-gray-900 sm:text-4xl">
                  Frequently Asked Questions
                </h2>
                <ul class="mt-4 space-y-4">
                  {campaignData.faqs.map((faq) => (
                    <li>
                      <h3 class="text-lg font-semibold">{faq.question}</h3>
                      <div class="prose mt-2" set:html={portableText.toHTML(faq.answer)} />
                    </li>
                  ))}
                </ul>
              </div>
            )}
        </section>
      )
    }
  </section>
  <Fragment slot="footer">
    <section class="footer-wrapper">
      <Footer />
    </section>
    {
      isAfterSept19 ? (
        <div class="mobile-donation-cta hidden">
          <a
            href="#give-form-mobile"
            class="donation-button bg-watermarkGreen text-white shadow-sm hover:bg-emerald-600 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-600 inline-block w-full rounded-sm px-3.5 py-2.5 text-sm font-semibold"
          >
            Ready to Give?
          </a>
        </div>
      ) : (
        <div class="mobile-donation-cta hidden">
          <a
            href="#give-form-mobile"
            class="donation-button text-gray-500 bg-gray-300 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 inline-block w-full rounded-sm px-3.5 py-2.5 text-sm font-semibold"
          >
            Giving Starts 9/21
          </a>
        </div>
      )
    }
  </Fragment>
  <script>
    const form = document.querySelector('#give-form-mobile')!;
    const button = document.querySelector('.mobile-donation-cta')!;

    const observer = new IntersectionObserver(
      (entries) => {
        const isFormVisible = entries[0]!.isIntersecting;
        if (isFormVisible) {
          button.classList.add('hidden');
        } else {
          button.classList.remove('hidden');
        }
      },
      {
        root: null,
        rootMargin: '0px',
        threshold: 0,
      },
    );

    observer.observe(form);
  </script>
</MainLayout>
